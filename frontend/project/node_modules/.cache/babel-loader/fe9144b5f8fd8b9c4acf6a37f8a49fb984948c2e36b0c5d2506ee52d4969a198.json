{"ast":null,"code":"import { createElementVNode as _createElementVNode, resolveComponent as _resolveComponent, createVNode as _createVNode, withCtx as _withCtx, toDisplayString as _toDisplayString, createTextVNode as _createTextVNode, openBlock as _openBlock, createBlock as _createBlock, createCommentVNode as _createCommentVNode, createElementBlock as _createElementBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"user-reviews\"\n};\nconst _hoisted_2 = {\n  class: \"product-list\"\n};\nconst _hoisted_3 = {\n  class: \"product-item\"\n};\nconst _hoisted_4 = {\n  class: \"product-details\"\n};\nconst _hoisted_5 = {\n  class: \"product-price\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  const _component_el_table_column = _resolveComponent(\"el-table-column\");\n  const _component_el_image = _resolveComponent(\"el-image\");\n  const _component_router_link = _resolveComponent(\"router-link\");\n  const _component_el_rate = _resolveComponent(\"el-rate\");\n  const _component_el_button = _resolveComponent(\"el-button\");\n  const _component_el_table = _resolveComponent(\"el-table\");\n  const _component_el_empty = _resolveComponent(\"el-empty\");\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_cache[1] || (_cache[1] = _createElementVNode(\"h2\", null, \"评价管理\", -1 /* HOISTED */)), _createVNode(_component_el_table, {\n    data: $setup.reviews,\n    border: \"\",\n    style: {\n      \"width\": \"100%\"\n    }\n  }, {\n    default: _withCtx(() => [_createVNode(_component_el_table_column, {\n      prop: \"orderItemId\",\n      label: \"订单项ID\",\n      width: \"120\"\n    }), _createVNode(_component_el_table_column, {\n      label: \"商品信息\"\n    }, {\n      default: _withCtx(({\n        row\n      }) => [_createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [_createVNode(_component_router_link, {\n        to: `/buyer/${$setup.username}/product/${row.item.id}`\n      }, {\n        default: _withCtx(() => [_createVNode(_component_el_image, {\n          src: row.item.image || '/placeholder-product.jpg',\n          style: {\n            \"width\": \"60px\",\n            \"height\": \"60px\"\n          },\n          fit: \"cover\"\n        }, null, 8 /* PROPS */, [\"src\"])]),\n        _: 2 /* DYNAMIC */\n      }, 1032 /* PROPS, DYNAMIC_SLOTS */, [\"to\"]), _createElementVNode(\"div\", _hoisted_4, [_createVNode(_component_router_link, {\n        to: `/buyer/${$setup.username}/product/${row.item.id}`,\n        class: \"product-name\"\n      }, {\n        default: _withCtx(() => [_createTextVNode(_toDisplayString(row.item.name || '商品信息缺失'), 1 /* TEXT */)]),\n        _: 2 /* DYNAMIC */\n      }, 1032 /* PROPS, DYNAMIC_SLOTS */, [\"to\"]), _createElementVNode(\"div\", _hoisted_5, \"¥\" + _toDisplayString((row.item.price || 0).toFixed(2)) + \" × \" + _toDisplayString(row.item.quantity || 1), 1 /* TEXT */)])])])]),\n      _: 1 /* STABLE */\n    }), _createVNode(_component_el_table_column, {\n      label: \"评分\",\n      width: \"120\"\n    }, {\n      default: _withCtx(scope => [_createVNode(_component_el_rate, {\n        modelValue: scope.row.rating,\n        \"onUpdate:modelValue\": $event => scope.row.rating = $event,\n        disabled: \"\",\n        \"show-score\": \"\",\n        \"text-color\": \"#ff9900\"\n      }, null, 8 /* PROPS */, [\"modelValue\", \"onUpdate:modelValue\"])]),\n      _: 1 /* STABLE */\n    }), _createVNode(_component_el_table_column, {\n      prop: \"comment\",\n      label: \"评价内容\"\n    }), _createVNode(_component_el_table_column, {\n      prop: \"date\",\n      label: \"评价时间\",\n      width: \"180\"\n    }), _createVNode(_component_el_table_column, {\n      label: \"操作\",\n      width: \"150\"\n    }, {\n      default: _withCtx(({\n        row\n      }) => [_createVNode(_component_el_button, {\n        type: \"danger\",\n        size: \"small\",\n        onClick: $event => $setup.deleteReview(row)\n      }, {\n        default: _withCtx(() => _cache[0] || (_cache[0] = [_createTextVNode(\"删除\")])),\n        _: 2 /* DYNAMIC */,\n        __: [0]\n      }, 1032 /* PROPS, DYNAMIC_SLOTS */, [\"onClick\"])]),\n      _: 1 /* STABLE */\n    })]),\n    _: 1 /* STABLE */\n  }, 8 /* PROPS */, [\"data\"]), $setup.reviews.length === 0 ? (_openBlock(), _createBlock(_component_el_empty, {\n    key: 0,\n    description: \"暂无评价记录\",\n    class: \"empty-tip\"\n  })) : _createCommentVNode(\"v-if\", true)]);\n}","map":{"version":3,"names":["class","_createElementBlock","_hoisted_1","_createElementVNode","_createVNode","_component_el_table","data","$setup","reviews","border","style","default","_withCtx","_component_el_table_column","prop","label","width","row","_hoisted_2","_hoisted_3","_component_router_link","to","username","item","id","_component_el_image","src","image","fit","_","_hoisted_4","_createTextVNode","_toDisplayString","name","_hoisted_5","price","toFixed","quantity","scope","_component_el_rate","modelValue","rating","$event","disabled","_component_el_button","type","size","onClick","deleteReview","_cache","__","length","_createBlock","_component_el_empty","key","description","_createCommentVNode"],"sources":["E:\\实验例子\\project\\src\\components\\UserReviews.vue"],"sourcesContent":["<template>\r\n  <div class=\"user-reviews\">\r\n    <h2>评价管理</h2>\r\n    \r\n    <el-table :data=\"reviews\" border style=\"width: 100%\">\r\n      <el-table-column prop=\"orderItemId\" label=\"订单项ID\" width=\"120\" />\r\n      \r\n      <el-table-column label=\"商品信息\">\r\n        <template #default=\"{ row }\">\r\n          <div class=\"product-list\">\r\n            <div class=\"product-item\">\r\n              <router-link :to=\"`/buyer/${username}/product/${row.item.id}`\">\r\n                <el-image \r\n                  :src=\"row.item.image || '/placeholder-product.jpg'\"\r\n                  style=\"width: 60px; height: 60px;\"\r\n                  fit=\"cover\"\r\n                />\r\n              </router-link>\r\n              <div class=\"product-details\">\r\n                <router-link :to=\"`/buyer/${username}/product/${row.item.id}`\" class=\"product-name\">\r\n                  {{ row.item.name || '商品信息缺失' }}\r\n                </router-link>\r\n                <div class=\"product-price\">¥{{ (row.item.price || 0).toFixed(2) }} × {{ row.item.quantity || 1 }}</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </template>\r\n      </el-table-column>\r\n      \r\n      <el-table-column label=\"评分\" width=\"120\">\r\n        <template #default=\"scope\">\r\n          <el-rate \r\n            v-model=\"scope.row.rating\"\r\n            disabled\r\n            show-score\r\n            text-color=\"#ff9900\"\r\n          />\r\n        </template>\r\n      </el-table-column>\r\n      \r\n      <el-table-column prop=\"comment\" label=\"评价内容\" />\r\n      \r\n      <el-table-column prop=\"date\" label=\"评价时间\" width=\"180\" />\r\n      \r\n      <el-table-column label=\"操作\" width=\"150\">\r\n        <template #default=\"{ row }\">\r\n          <el-button type=\"danger\" size=\"small\" @click=\"deleteReview(row)\">删除</el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <el-empty \r\n      v-if=\"reviews.length === 0\" \r\n      description=\"暂无评价记录\"\r\n      class=\"empty-tip\"\r\n    />\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted, computed } from 'vue'\r\nimport { ElMessage, ElMessageBox } from 'element-plus'\r\nimport axios from 'axios'\r\n\r\nconst reviews = ref([])\r\n\r\n// JWT 解析函数\r\nconst parseJwt = (token) => {\r\n  try {\r\n    const base64Url = token.split('.')[1]\r\n    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/')\r\n    const jsonPayload = decodeURIComponent(\r\n      atob(base64)\r\n        .split('')\r\n        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\r\n        .join('')\r\n    )\r\n    return JSON.parse(jsonPayload)\r\n  } catch (e) {\r\n    console.error('Token解析失败:', e)\r\n    return null\r\n  }\r\n}\r\n\r\n// 从token获取用户名\r\nconst token = localStorage.getItem('token')\r\nconst username = computed(() => {\r\n  if (token) {\r\n    const payload = parseJwt(token)\r\n    return payload.username || 'guest'\r\n  }\r\n  return 'guest'\r\n})\r\n\r\n// 从Token获取用户ID\r\nconst getCustomerIdFromToken = () => {\r\n  const token = localStorage.getItem('token')\r\n  if (!token) {\r\n    ElMessage.error('用户未登录，请先登录')\r\n    return null\r\n  }\r\n  try {\r\n    const decoded = parseJwt(token)\r\n    return decoded.customerId || null\r\n  } catch (error) {\r\n    console.error('Token解析失败:', error)\r\n    ElMessage.error('用户信息解析失败')\r\n    return null\r\n  }\r\n}\r\n\r\n// 加载评价数据\r\nconst loadReviews = async () => {\r\n  try {\r\n    const customerId = getCustomerIdFromToken()\r\n    if (!customerId) {\r\n      ElMessage.error('无法获取用户信息')\r\n      return\r\n    }\r\n    \r\n    // 从后端获取评价列表\r\n    const response = await axios.get(\r\n      `http://algorineko.top:8080/api/customer/review/customer/${customerId}`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        }\r\n      }\r\n    )\r\n    \r\n    // 获取本地存储的商品快照\r\n    const savedReviews = JSON.parse(localStorage.getItem('productReviews') || '[]')\r\n    \r\n    // 合并数据：后端返回的评价数据 + 本地存储的商品快照\r\n    reviews.value = response.data.map(apiReview => {\r\n      // 查找本地存储中对应的评价（如果有）\r\n      const localReview = savedReviews.find(r => \r\n        r.orderItemId === apiReview.orderItemId\r\n      )\r\n      \r\n      // 使用本地存储的商品快照（如果存在）\r\n      const itemSnapshot = localReview?.itemSnapshot || {}\r\n      \r\n      return {\r\n        ...apiReview,\r\n        content: apiReview.comment, // 为了兼容原有模板\r\n        date: localReview?.date || new Date().toLocaleString(), // 保留原有日期\r\n        item: {\r\n          id: itemSnapshot.id || 0,\r\n          name: itemSnapshot.name || '商品信息缺失',\r\n          price: itemSnapshot.price || 0,\r\n          quantity: itemSnapshot.quantity || 1,\r\n          image: itemSnapshot.image || '/placeholder-product.jpg'\r\n        }\r\n      }\r\n    })\r\n    \r\n  } catch (error) {\r\n    console.error('加载评价失败:', error)\r\n    ElMessage.error('加载评价失败')\r\n    reviews.value = []\r\n  }\r\n}\r\n\r\nconst deleteReview = async (review) => {\r\n  try {\r\n    await ElMessageBox.confirm(\r\n      '确定要删除这个评价吗？删除后无法恢复',\r\n      '警告',\r\n      {\r\n        confirmButtonText: '确定删除',\r\n        cancelButtonText: '取消',\r\n        type: 'warning'\r\n      }\r\n    )\r\n    \r\n    // 调用后端API删除评价 - 使用正确的URL格式\r\n    await axios.delete(\r\n      `http://algorineko.top:8080/api/customer/review/${review.reviewId}`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        }\r\n      }\r\n    )\r\n    \r\n    // 从本地存储中移除商品快照\r\n    const savedReviews = JSON.parse(localStorage.getItem('productReviews') || '[]')\r\n    const newReviews = savedReviews.filter(r => \r\n      r.orderItemId !== review.orderItemId\r\n    )\r\n    localStorage.setItem('productReviews', JSON.stringify(newReviews))\r\n    \r\n    // 重新加载评价\r\n    loadReviews()\r\n    ElMessage.success('删除成功')\r\n    \r\n  } catch (error) {\r\n    if (error !== 'cancel') {\r\n      console.error('删除评价失败:', error)\r\n      ElMessage.error('删除评价失败')\r\n    }\r\n  }\r\n}\r\n\r\nonMounted(loadReviews)\r\n</script>\r\n\r\n<style scoped>\r\n.user-reviews {\r\n  padding: 20px;\r\n  background: #fff;\r\n}\r\n\r\n.empty-tip {\r\n  margin-top: 50px;\r\n}\r\n\r\n.product-list {\r\n  padding: 10px 0;\r\n}\r\n\r\n.product-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n  padding: 10px 0;\r\n}\r\n\r\n.product-details {\r\n  flex: 1;\r\n}\r\n\r\n.product-name {\r\n  font-weight: 500;\r\n  margin-bottom: 5px;\r\n  color: #606266;\r\n  text-decoration: none;\r\n  display: block;\r\n  cursor: pointer;\r\n  transition: color 0.3s;\r\n}\r\n\r\n.product-name:hover {\r\n  color: #409eff;\r\n  text-decoration: underline;\r\n}\r\n\r\n.product-price {\r\n  color: #f56c6c;\r\n  font-size: 14px;\r\n}\r\n\r\n/* 图片链接样式 */\r\na {\r\n  text-decoration: none;\r\n  color: inherit;\r\n}\r\n\r\n/* 图片悬停效果 */\r\n.el-image {\r\n  transition: transform 0.3s;\r\n}\r\n\r\n.el-image:hover {\r\n  transform: scale(1.05);\r\n}\r\n</style>"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}