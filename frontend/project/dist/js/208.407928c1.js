"use strict";(self["webpackChunkproject"]=self["webpackChunkproject"]||[]).push([[208],{208:function(e,t,a){a.r(t),a.d(t,{default:function(){return w}});a(4114),a(8111),a(2489),a(116),a(531),a(7588),a(1701),a(7642),a(8004),a(3853),a(5876),a(2475),a(5024),a(1698),a(4979);var r=a(6768),l=a(4232),o=a(144),s=a(1219),n=a(1147);const i={class:"order-section"},u={class:"filter-bar"},d={class:"filter-group"},c={class:"product-row"},p={class:"product-details"},m={class:"product-name"},g={class:"product-meta"},k={class:"product-price"},b={class:"product-subtotal"},v={key:0},h={key:1},f={class:"tracking-input"};var y={__name:"OrderManagement",setup(e){const t=(0,o.KR)({status:"all",dateRange:[]}),a=(0,o.KR)([]),y=(0,o.KR)(!1),I=(0,o.KR)(""),_=(0,o.KR)({trackingCompany:"",trackingNumber:""}),w=()=>{const e=localStorage.getItem("token");if(!e)return s.nk.error("用户未登录，请先登录"),null;try{const t=e.split(".")[1],a=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(a).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join("")),l=JSON.parse(r);return l.merchantId||null}catch(t){return console.error("Token解析失败:",t),s.nk.error("商家信息解析失败"),null}},F={pending:{text:"待付款",type:"warning"},PENDING:{text:"待付款",type:"warning"},paid:{text:"已付款",type:"primary"},PAID:{text:"已付款",type:"primary"},shipped:{text:"已发货",type:"success"},SHIPPED:{text:"已发货",type:"success"},completed:{text:"已完成",type:"info"},COMPLETED:{text:"已完成",type:"info"}},C=async(e,t,r)=>{try{const l=w();if(!l)return s.nk.error("无法获取商家信息"),!1;const o=a.value.find((t=>t.orderId===e));if(!o||!o.items)return s.nk.error("未找到订单项信息"),!1;const i=o.items.map((e=>({orderItemId:e.orderItemId,logisticsCompany:t,trackingNumber:r,status:"SHIPPED"})));console.log("物流列表:",i);const u=await n.A.post("http://algorineko.top:8080/api/order/shipping",{orderId:e,logisticsList:i},{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});return 200===u.status}catch(l){console.error("发货操作失败:",l);let e="发货失败";return l.response&&(400===l.response.status?e="请求参数错误":401===l.response.status?e="未授权操作":l.response.data&&l.response.data.message&&(e=l.response.data.message)),s.nk.error(e),!1}},S=(0,r.EW)((()=>{const e=[];return x.value.forEach((t=>{t.items.forEach(((a,r)=>{e.push({...t,item:a,isFirstItem:0===r})}))})),e})),x=(0,r.EW)((()=>(a.value||[]).filter((e=>{const a="all"===t.value.status||e.status.toLowerCase()===t.value.status.toLowerCase(),r=!t.value.dateRange?.length||new Date(e.createTime)>=new Date(t.value.dateRange[0])&&new Date(e.createTime)<=new Date(t.value.dateRange[1]);return a&&r})))),N=()=>{let e=localStorage.getItem("lastTrackingNumber")||0;return e=parseInt(e)+1,localStorage.setItem("lastTrackingNumber",e.toString()),e.toString().padStart(10,"0")},V=e=>{I.value=e,_.value.trackingNumber=N(),_.value.trackingCompany="",y.value=!0},E=async()=>{if(!_.value.trackingCompany)return void s.nk.warning("请输入物流公司");if(!_.value.trackingNumber)return void s.nk.warning("请输入物流单号");const e=await C(I.value,_.value.trackingCompany,_.value.trackingNumber);if(e){const e=JSON.parse(localStorage.getItem("orders")||"[]"),t=e.map((e=>e.orderId===I.value?{...e,status:"SHIPPED",shipTime:(new Date).toLocaleString(),trackingCompany:_.value.trackingCompany,trackingNumber:_.value.trackingNumber}:e));localStorage.setItem("orders",JSON.stringify(t)),s.nk.success("发货成功！"),y.value=!1,L()}},L=async()=>{try{const e=w();if(!e)return void s.nk.error("无法获取商家信息");const t=await n.A.get(`http://algorineko.top:8080/api/order/merchant/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),r=t.data.map((e=>({orderId:e.orderId,merchantId:e.merchantId,totalPrice:e.totalPrice,status:e.status,createTime:(new Date).toLocaleString(),items:e.items.map((e=>({orderItemId:e.orderItemId,productId:e.productId,name:`商品 ${e.productId}`,price:e.price,quantity:e.quantity,image:"/placeholder-product.jpg"})))})));console.log("订单列表:",r);const l=[...new Set(r.flatMap((e=>e.items.map((e=>e.productId)))))],o=l.map((e=>n.A.get(`http://algorineko.top:8080/api/merchant/product/detail/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}).catch((t=>(console.error(`获取商品${e}详情失败:`,t),null))))),i=await Promise.all(o),u={};i.forEach(((e,t)=>{if(e&&e.data){const a=e.data;u[l[t]]={name:a.productName,image:a.images&&a.images.length>0?a.images[0]:"/placeholder-product.jpg"}}})),r.forEach((e=>{e.items.forEach((e=>{const t=u[e.productId];t&&(e.name=t.name,e.image=t.image)}))})),localStorage.setItem("orders",JSON.stringify(r)),a.value=r}catch(e){console.error("加载订单失败:",e);let t="订单加载失败";e.response?401===e.response.status?t="用户未认证，请重新登录":403===e.response.status?t="没有权限访问订单数据":e.response.data&&e.response.data.message&&(t=e.response.data.message):e.request&&(t="无法连接到服务器，请检查网络连接"),s.nk.error(t),a.value=[]}};return(0,r.sV)((()=>{L()})),(e,a)=>{const o=(0,r.g2)("el-option"),s=(0,r.g2)("el-select"),n=(0,r.g2)("el-date-picker"),w=(0,r.g2)("el-button"),C=(0,r.g2)("el-table-column"),x=(0,r.g2)("el-image"),P=(0,r.g2)("el-tag"),D=(0,r.g2)("el-table"),R=(0,r.g2)("el-input"),W=(0,r.g2)("el-form-item"),A=(0,r.g2)("el-form"),T=(0,r.g2)("el-dialog");return(0,r.uX)(),(0,r.CE)("div",i,[a[14]||(a[14]=(0,r.Lk)("h2",null,[(0,r.Lk)("i",{class:"el-icon-tickets"}),(0,r.eW)(" 订单管理")],-1)),(0,r.Lk)("div",u,[(0,r.Lk)("div",d,[(0,r.bF)(s,{modelValue:t.value.status,"onUpdate:modelValue":a[0]||(a[0]=e=>t.value.status=e),placeholder:"订单状态",style:{width:"150px"}},{default:(0,r.k6)((()=>[(0,r.bF)(o,{label:"全部",value:"all"}),(0,r.bF)(o,{label:"待付款",value:"pending"}),(0,r.bF)(o,{label:"已付款",value:"paid"}),(0,r.bF)(o,{label:"已发货",value:"shipped"}),(0,r.bF)(o,{label:"已完成",value:"completed"})])),_:1},8,["modelValue"]),(0,r.bF)(n,{modelValue:t.value.dateRange,"onUpdate:modelValue":a[1]||(a[1]=e=>t.value.dateRange=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",style:{width:"350px"}},null,8,["modelValue"])]),(0,r.bF)(w,{type:"primary",icon:"el-icon-search",onClick:L},{default:(0,r.k6)((()=>a[8]||(a[8]=[(0,r.eW)("搜索")]))),_:1,__:[8]})]),(0,r.bF)(D,{data:S.value,border:"",style:{width:"100%"},class:"data-table"},{default:(0,r.k6)((()=>[(0,r.bF)(C,{prop:"orderId",label:"订单号",width:"180"}),(0,r.bF)(C,{prop:"createTime",label:"下单时间",width:"180"}),(0,r.bF)(C,{label:"商品信息"},{default:(0,r.k6)((({row:e})=>[(0,r.Lk)("div",c,[(0,r.bF)(x,{src:e.item.image||"/placeholder-product.jpg",style:{width:"60px",height:"60px","border-radius":"4px"},fit:"cover"},null,8,["src"]),(0,r.Lk)("div",p,[(0,r.Lk)("div",m,(0,l.v_)(e.item.name),1),(0,r.Lk)("div",g,[(0,r.Lk)("span",k,"¥"+(0,l.v_)((e.item.price||0).toFixed(2))+" × "+(0,l.v_)(e.item.quantity||1),1),(0,r.Lk)("span",b,"小计: ¥"+(0,l.v_)(((e.item.price||0)*(e.item.quantity||1)).toFixed(2)),1)])])])])),_:1}),(0,r.bF)(C,{label:"金额",width:"120",align:"right"},{default:(0,r.k6)((({row:e})=>[(0,r.eW)(" ¥"+(0,l.v_)(((e.item.price||0)*(e.item.quantity||1)).toFixed(2)),1)])),_:1}),(0,r.bF)(C,{label:"状态",width:"120"},{default:(0,r.k6)((({row:e})=>[(0,r.bF)(P,{type:F[e?.status]?.type||"info"},{default:(0,r.k6)((()=>[(0,r.eW)((0,l.v_)(F[e?.status]?.text||"未知状态"),1)])),_:2},1032,["type"])])),_:1}),(0,r.bF)(C,{label:"操作",width:"150"},{default:(0,r.k6)((({row:e})=>[e?((0,r.uX)(),(0,r.CE)("div",v,["paid"!==e.status&&"PAID"!==e.status||!e.isFirstItem?"shipped"!==e.status&&"SHIPPED"!==e.status||!e.isFirstItem?(0,r.Q3)("",!0):((0,r.uX)(),(0,r.CE)("span",h,[(0,r.bF)(P,{type:"success"},{default:(0,r.k6)((()=>a[10]||(a[10]=[(0,r.eW)("已发货")]))),_:1,__:[10]})])):((0,r.uX)(),(0,r.Wv)(w,{key:0,size:"small",type:"success",icon:"el-icon-truck",onClick:t=>V(e.orderId)},{default:(0,r.k6)((()=>a[9]||(a[9]=[(0,r.eW)("发货")]))),_:2,__:[9]},1032,["onClick"]))])):(0,r.Q3)("",!0)])),_:1})])),_:1},8,["data"]),(0,r.bF)(T,{modelValue:y.value,"onUpdate:modelValue":a[7]||(a[7]=e=>y.value=e),title:"订单发货",width:"500px"},{footer:(0,r.k6)((()=>[(0,r.bF)(w,{onClick:a[6]||(a[6]=e=>y.value=!1)},{default:(0,r.k6)((()=>a[12]||(a[12]=[(0,r.eW)("取消")]))),_:1,__:[12]}),(0,r.bF)(w,{type:"primary",onClick:E},{default:(0,r.k6)((()=>a[13]||(a[13]=[(0,r.eW)("确定发货")]))),_:1,__:[13]})])),default:(0,r.k6)((()=>[(0,r.bF)(A,{model:_.value,"label-width":"100px"},{default:(0,r.k6)((()=>[(0,r.bF)(W,{label:"订单号"},{default:(0,r.k6)((()=>[(0,r.bF)(R,{modelValue:I.value,"onUpdate:modelValue":a[2]||(a[2]=e=>I.value=e),disabled:""},null,8,["modelValue"])])),_:1}),(0,r.bF)(W,{label:"物流公司",required:""},{default:(0,r.k6)((()=>[(0,r.bF)(R,{modelValue:_.value.trackingCompany,"onUpdate:modelValue":a[3]||(a[3]=e=>_.value.trackingCompany=e),placeholder:"请输入物流公司名称"},null,8,["modelValue"])])),_:1}),(0,r.bF)(W,{label:"物流单号"},{default:(0,r.k6)((()=>[(0,r.Lk)("div",f,[(0,r.bF)(R,{modelValue:_.value.trackingNumber,"onUpdate:modelValue":a[4]||(a[4]=e=>_.value.trackingNumber=e),placeholder:"请输入物流单号",clearable:""},null,8,["modelValue"]),(0,r.bF)(w,{type:"primary",plain:"",size:"small",onClick:a[5]||(a[5]=e=>_.value.trackingNumber=N())},{default:(0,r.k6)((()=>a[11]||(a[11]=[(0,r.eW)(" 生成单号 ")]))),_:1,__:[11]})])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},I=a(1241);const _=(0,I.A)(y,[["__scopeId","data-v-26dafb9e"]]);var w=_}}]);
//# sourceMappingURL=208.407928c1.js.map