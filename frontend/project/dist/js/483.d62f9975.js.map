{"version":3,"file":"js/483.d62f9975.js","mappings":"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","sources":["webpack://project/./src/views/business/BusinessInfo.vue","webpack://project/./src/views/business/BusinessInfo.vue?516d"],"sourcesContent":["<template>\r\n  <div class=\"info-section\">\r\n    <h2><i class=\"el-icon-user\"></i> 商家信息管理</h2>\r\n    <el-card class=\"info-card\">\r\n      <el-form label-width=\"120px\">\r\n        <el-form-item label=\"商家用户名\">\r\n          <el-input v-model=\"shopInfo.username\" disabled />\r\n          <div class=\"info-tip\">商家用户名不可更改</div>\r\n        </el-form-item>\r\n        <el-form-item label=\"旧密码\">\r\n          <el-input \r\n            v-model=\"oldPassword\" \r\n            type=\"password\" \r\n            show-password\r\n            placeholder=\"请输入当前密码\" \r\n          />\r\n        </el-form-item>\r\n        <el-form-item label=\"新密码\">\r\n          <el-input \r\n            v-model=\"shopInfo.password\" \r\n            type=\"password\" \r\n            show-password\r\n            placeholder=\"请输入新密码\" \r\n          />\r\n          <div class=\"info-tip\">留空则不修改密码</div>\r\n        </el-form-item>\r\n        <el-form-item label=\"商家地址\">\r\n          <el-input v-model=\"shopInfo.address\" placeholder=\"请输入商家地址\" />\r\n        </el-form-item>\r\n        <el-form-item label=\"联系电话\">\r\n          <el-input v-model=\"shopInfo.phoneNumber\" placeholder=\"请输入联系电话\" />\r\n        </el-form-item>\r\n        <el-form-item label=\"商家头像\">\r\n          <div class=\"avatar-upload\">\r\n            <el-avatar \r\n              :size=\"120\" \r\n              :src=\"shopInfo.avatar\" \r\n              class=\"avatar-preview\"\r\n            />\r\n            <div class=\"avatar-actions\">\r\n              <el-upload\r\n                action=\"#\"\r\n                :show-file-list=\"false\"\r\n                :auto-upload=\"false\"\r\n                :on-change=\"handleAvatarChange\"\r\n              >\r\n                <el-button type=\"primary\" icon=\"el-icon-upload\" size=\"small\">上传头像</el-button>\r\n              </el-upload>\r\n              <el-button \r\n                v-if=\"shopInfo.avatar\" \r\n                type=\"danger\" \r\n                icon=\"el-icon-delete\" \r\n                size=\"small\"\r\n                @click=\"removeAvatar\"\r\n              >\r\n                移除\r\n              </el-button>\r\n            </div>\r\n          </div>\r\n        </el-form-item>\r\n        <div class=\"form-actions\">\r\n          <el-button type=\"primary\" @click=\"saveShopInfo\" :loading=\"loading\">\r\n            <i class=\"el-icon-check\"></i> 保存修改\r\n          </el-button>\r\n          <el-button @click=\"resetForm\">\r\n            <i class=\"el-icon-refresh\"></i> 重置修改\r\n          </el-button>\r\n        </div>\r\n      </el-form>\r\n    </el-card>\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted } from 'vue'\r\nimport { ElMessage, ElNotification } from 'element-plus'\r\nimport axios from 'axios'\r\n\r\nconst shopInfo = ref({\r\n  username: '',\r\n  password: '',\r\n  address: '',\r\n  phoneNumber: '',\r\n  avatar: ''\r\n})\r\nconst oldPassword = ref('')\r\nconst loading = ref(false)\r\nconst originalShopInfo = ref({})\r\n\r\n// 检查Token有效性\r\nconst checkTokenValidity = () => {\r\n  const token = localStorage.getItem('token')\r\n  if (!token) {\r\n    ElMessage.error('用户未登录，请重新登录')\r\n    redirectToLogin()\r\n    return false\r\n  }\r\n  \r\n  return true\r\n}\r\n\r\n// 重定向到登录页\r\nconst redirectToLogin = () => {\r\n  localStorage.removeItem('token')\r\n  setTimeout(() => {\r\n    window.location.href = '/login'\r\n  }, 1500)\r\n}\r\n\r\n// 获取商家信息\r\nconst fetchShopInfo = async () => {\r\n  if (!checkTokenValidity()) return\r\n  \r\n  try {\r\n    const token = localStorage.getItem('token')\r\n    const response = await axios.get('http://algorineko.top:8080/api/merchants/profile', {\r\n      headers: {\r\n        'Authorization': `Bearer ${token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      timeout: 10000\r\n      \r\n    })\r\n    \r\n    console.log('response.data', response.data)\r\n    // 根据实际API响应结构调整\r\n    const data = response.data.data || response.data\r\n    \r\n    // 映射字段到本地数据结构\r\n    shopInfo.value = {\r\n      username: data.merchantName || data.username || '',\r\n      password: '',\r\n      address: data.merchantAddress || data.address || '',\r\n      phoneNumber: data.phoneNumber || '',\r\n      avatar: data.headPicture || data.avatar || ''\r\n    }\r\n   \r\n    if (data.merchantId) {\r\n      localStorage.setItem('userId', data.merchantId.toString())\r\n    } else if (data.id) {\r\n      localStorage.setItem('userId', data.id.toString())\r\n    }\r\n    \r\n    // 从本地存储获取头像（如果存在）\r\n    const userId = localStorage.getItem('userId')\r\n    if (userId) {\r\n      const localAvatar = localStorage.getItem(`merchant_avatar_${userId}`)\r\n      if (localAvatar) {\r\n        shopInfo.value.avatar = localAvatar\r\n      }\r\n    }\r\n\r\n    originalShopInfo.value = { ...shopInfo.value }\r\n  } catch (error) {\r\n    console.error('获取商家信息失败:', error)\r\n    \r\n    let errorMessage = '获取商家信息失败，请重试'\r\n    if (error.response) {\r\n      if (error.response.status === 401) {\r\n        errorMessage = '身份验证失败，请重新登录'\r\n        redirectToLogin()\r\n      } else if (error.response.data && error.response.data.message) {\r\n        errorMessage = error.response.data.message\r\n      }\r\n    }\r\n    \r\n    ElMessage.error(errorMessage)\r\n  }\r\n}\r\n\r\n// 保存商家信息\r\nconst saveShopInfo = async () => {\r\n  if (!checkTokenValidity()) return\r\n  \r\n  loading.value = true\r\n  const token = localStorage.getItem('token')\r\n  \r\n  try {\r\n    // 1. 更新联系信息\r\n    await axios.put('http://algorineko.top:8080/api/merchants/putProfile', {\r\n      merchantAddress: shopInfo.value.address, // 使用后端需要的字段名\r\n      phoneNumber: shopInfo.value.phoneNumber\r\n    }, {\r\n      headers: {\r\n        'Authorization': `Bearer ${token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      timeout: 10000\r\n    })\r\n\r\n    // 2. 如果有新密码则更新密码\r\n    if (shopInfo.value.password) {\r\n      if (!oldPassword.value) {\r\n        ElMessage.warning('修改密码需要提供旧密码')\r\n        loading.value = false\r\n        return\r\n      }\r\n      \r\n      await axios.put('http://algorineko.top:8080/api/merchants/change-password', {\r\n        oldPassword: oldPassword.value,\r\n        newPassword: shopInfo.value.password\r\n      }, {\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json'\r\n        },\r\n        timeout: 10000\r\n      })\r\n    }\r\n\r\n    // 3. 更新成功后重置表单状态\r\n    originalShopInfo.value = { ...shopInfo.value }\r\n    oldPassword.value = ''\r\n    shopInfo.value.password = ''\r\n    \r\n    // 4. 重新获取最新数据确保一致性\r\n    await fetchShopInfo()\r\n    \r\n    ElNotification.success({\r\n      title: '保存成功',\r\n      message: '商家信息已更新',\r\n      duration: 2000\r\n    })\r\n  } catch (error) {\r\n    console.error('保存失败:', error)\r\n    \r\n    let errorMessage = '保存失败，请重试'\r\n    if (error.response) {\r\n      if (error.response.status === 400) {\r\n        errorMessage = error.response.data.message || '请求参数错误'\r\n      } else if (error.response.status === 401) {\r\n        errorMessage = '身份验证失败，请重新登录'\r\n        redirectToLogin()\r\n      } else if (error.response.status === 403) {\r\n        errorMessage = '旧密码不正确'\r\n      } else if (error.response.data && error.response.data.message) {\r\n        errorMessage = error.response.data.message\r\n      }\r\n    }\r\n    \r\n    ElMessage.error(errorMessage)\r\n  } finally {\r\n    loading.value = false\r\n  }\r\n}\r\n\r\n// 重置表单\r\nconst resetForm = () => {\r\n  shopInfo.value = { ...originalShopInfo.value }\r\n  oldPassword.value = ''\r\n  shopInfo.value.password = ''\r\n  ElMessage.info('已重置修改内容')\r\n}\r\n\r\n// 头像上传处理\r\nconst handleAvatarChange = (file) => {\r\n  if (!file) return\r\n  const rawFile = file.raw\r\n  if (rawFile) {\r\n    const reader = new FileReader()\r\n    reader.onload = (e) => {\r\n      shopInfo.value.avatar = e.target.result\r\n      \r\n      // 将头像保存到本地存储\r\n      const userId = localStorage.getItem('userId')\r\n      if (userId) {\r\n        localStorage.setItem(`merchant_avatar_${userId}`, e.target.result)\r\n      }\r\n    }\r\n    reader.readAsDataURL(rawFile)\r\n  }\r\n}\r\n\r\n// 移除头像\r\nconst removeAvatar = () => {\r\n  shopInfo.value.avatar = ''\r\n  \r\n  // 从本地存储移除头像\r\n  const userId = localStorage.getItem('userId')\r\n  if (userId) {\r\n    localStorage.removeItem(`merchant_avatar_${userId}`)\r\n  }\r\n}\r\n\r\n// 组件挂载时获取商家信息\r\nonMounted(() => {\r\n  fetchShopInfo()\r\n})\r\n</script>\r\n\r\n<style scoped>\r\n.info-section h2 {\r\n  margin-top: 0;\r\n  margin-bottom: 25px;\r\n  color: #303133;\r\n  font-size: 22px;\r\n  font-weight: 600;\r\n  display: flex;\r\n  align-items: center;\r\n  padding-bottom: 15px;\r\n  border-bottom: 1px solid #ebeef5;\r\n}\r\n\r\n.info-section h2 i {\r\n  margin-right: 12px;\r\n  font-size: 24px;\r\n  color: #409eff;\r\n}\r\n\r\n.info-card {\r\n  border-radius: 10px;\r\n  box-shadow: 0 4px 12px rgba(0,0,0,0.05);\r\n  border: none;\r\n}\r\n\r\n.avatar-upload {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 25px;\r\n}\r\n\r\n.avatar-preview {\r\n  border: 1px dashed #dcdfe6;\r\n  border-radius: 8px;\r\n  background-color: #f8f9fa;\r\n}\r\n\r\n.avatar-actions {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 10px;\r\n}\r\n\r\n.info-tip {\r\n  font-size: 12px;\r\n  color: #909399;\r\n  margin-top: 5px;\r\n}\r\n\r\n.form-actions {\r\n  display: flex;\r\n  justify-content: center;\r\n  gap: 20px;\r\n  margin-top: 30px;\r\n}\r\n\r\n.form-actions .el-button {\r\n  padding: 12px 30px;\r\n  font-size: 16px;\r\n}\r\n</style>","import script from \"./BusinessInfo.vue?vue&type=script&setup=true&lang=js\"\nexport * from \"./BusinessInfo.vue?vue&type=script&setup=true&lang=js\"\n\nimport \"./BusinessInfo.vue?vue&type=style&index=0&id=1f605786&scoped=true&lang=css\"\n\nimport exportComponent from \"../../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['__scopeId',\"data-v-1f605786\"]])\n\nexport default __exports__"],"names":["shopInfo","ref","username","password","address","phoneNumber","avatar","oldPassword","loading","originalShopInfo","checkTokenValidity","token","localStorage","getItem","ElMessage","error","redirectToLogin","removeItem","setTimeout","window","location","href","fetchShopInfo","async","response","axios","get","headers","timeout","console","log","data","value","merchantName","merchantAddress","headPicture","merchantId","setItem","toString","id","userId","localAvatar","errorMessage","status","message","saveShopInfo","put","warning","newPassword","ElNotification","success","title","duration","resetForm","info","handleAvatarChange","file","rawFile","raw","reader","FileReader","onload","e","target","result","readAsDataURL","removeAvatar","onMounted","__exports__"],"sourceRoot":""}