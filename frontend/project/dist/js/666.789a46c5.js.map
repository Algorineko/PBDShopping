{"version":3,"file":"js/666.789a46c5.js","mappings":"4aAgEA,MAAMA,GAAUC,EAAAA,EAAAA,IAAI,IAGdC,EAAYC,IAChB,IACE,MAAMC,EAAYD,EAAME,MAAM,KAAK,GAC7BC,EAASF,EAAUG,QAAQ,KAAM,KAAKA,QAAQ,KAAM,KACpDC,EAAcC,mBAClBC,KAAKJ,GACFD,MAAM,IACNM,KAAIC,GAAK,KAAO,KAAOA,EAAEC,WAAW,GAAGC,SAAS,KAAKC,OAAO,KAC5DC,KAAK,KAEV,OAAOC,KAAKC,MAAMV,EACpB,CAAE,MAAOW,GAEP,OADAC,QAAQC,MAAM,aAAcF,GACrB,IACT,GAIIhB,EAAQmB,aAAaC,QAAQ,SAC7BC,GAAWC,EAAAA,EAAAA,KAAS,KACxB,GAAItB,EAAO,CACT,MAAMuB,EAAUxB,EAASC,GACzB,OAAOuB,EAAQC,KAAO,OACxB,CACA,MAAO,OAAO,IAIVC,EAAyBA,KAC7B,MAAMzB,EAAQmB,aAAaC,QAAQ,SACnC,IAAKpB,EAEH,OADA0B,EAAAA,GAAUR,MAAM,cACT,KAET,IACE,MAAMS,EAAU5B,EAASC,GACzB,OAAO2B,EAAQC,YAAc,IAC/B,CAAE,MAAOV,GAGP,OAFAD,QAAQC,MAAM,aAAcA,GAC5BQ,EAAAA,GAAUR,MAAM,YACT,IACT,GAIIW,EAAcC,UAClB,IACE,MAAMF,EAAaH,IACnB,IAAKG,EAEH,YADAF,EAAAA,GAAUR,MAAM,YAKlB,MAAMa,QAAiBC,EAAAA,EAAMC,IAC3B,2DAA2DL,IAC3D,CACEM,QAAS,CACP,cAAiB,UAAUf,aAAaC,QAAQ,cAMhDe,EAAerB,KAAKC,MAAMI,aAAaC,QAAQ,mBAAqB,MAG1EvB,EAAQuC,MAAQL,EAASM,KAAK7B,KAAI8B,IAEhC,MAAMC,EAAcJ,EAAaK,MAAKC,GACpCA,EAAEC,cAAgBJ,EAAUI,cAIxBC,EAAeJ,GAAaI,cAAgB,CAAC,EAEnD,MAAO,IACFL,EACHM,QAASN,EAAUO,QACnBC,KAAMP,GAAaO,OAAQ,IAAIC,MAAOC,iBACtCC,KAAM,CACJC,GAAIP,EAAaO,IAAM,EACvBC,KAAMR,EAAaQ,MAAQ,SAC3BC,MAAOT,EAAaS,OAAS,EAC7BC,SAAUV,EAAaU,UAAY,EACnCC,MAAOX,EAAaW,OAAS,4BAEhC,GAGL,CAAE,MAAOpC,GACPD,QAAQC,MAAM,UAAWA,GACzBQ,EAAAA,GAAUR,MAAM,UAChBrB,EAAQuC,MAAQ,EAClB,GAGImB,EAAezB,UACnB,UACQ0B,EAAAA,EAAaC,QACjB,qBACA,KACA,CACEC,kBAAmB,OACnBC,iBAAkB,KAClBC,KAAM,kBAKJ5B,EAAAA,EAAM6B,OACV,kDAAkDC,EAAOC,WACzD,CACE7B,QAAS,CACP,cAAiB,UAAUf,aAAaC,QAAQ,cAMtD,MAAMe,EAAerB,KAAKC,MAAMI,aAAaC,QAAQ,mBAAqB,MACpE4C,EAAa7B,EAAa8B,QAAOxB,GACrCA,EAAEC,cAAgBoB,EAAOpB,cAE3BvB,aAAa+C,QAAQ,iBAAkBpD,KAAKqD,UAAUH,IAGtDnC,IACAH,EAAAA,GAAU0C,QAAQ,OAEpB,CAAE,MAAOlD,GACO,WAAVA,IACFD,QAAQC,MAAM,UAAWA,GACzBQ,EAAAA,GAAUR,MAAM,UAEpB,G,OAGFmD,EAAAA,EAAAA,IAAUxC,G,8qDCvMV,MAAMyC,GAA2B,OAAgB,EAAQ,CAAC,CAAC,YAAY,qBAEvE,O","sources":["webpack://project/./src/components/UserReviews.vue","webpack://project/./src/components/UserReviews.vue?e122"],"sourcesContent":["<template>\r\n  <div class=\"user-reviews\">\r\n    <h2>评价管理</h2>\r\n    \r\n    <el-table :data=\"reviews\" border style=\"width: 100%\">\r\n      <el-table-column prop=\"orderItemId\" label=\"订单项ID\" width=\"120\" />\r\n      \r\n      <el-table-column label=\"商品信息\">\r\n        <template #default=\"{ row }\">\r\n          <div class=\"product-list\">\r\n            <div class=\"product-item\">\r\n              <router-link :to=\"`/buyer/${username}/product/${row.item.id}`\">\r\n                <el-image \r\n                  :src=\"row.item.image || '/placeholder-product.jpg'\"\r\n                  style=\"width: 60px; height: 60px;\"\r\n                  fit=\"cover\"\r\n                />\r\n              </router-link>\r\n              <div class=\"product-details\">\r\n                <router-link :to=\"`/buyer/${username}/product/${row.item.id}`\" class=\"product-name\">\r\n                  {{ row.item.name || '商品信息缺失' }}\r\n                </router-link>\r\n                <div class=\"product-price\">¥{{ (row.item.price || 0).toFixed(2) }} × {{ row.item.quantity || 1 }}</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </template>\r\n      </el-table-column>\r\n      \r\n      <el-table-column label=\"评分\" width=\"120\">\r\n        <template #default=\"scope\">\r\n          <el-rate \r\n            v-model=\"scope.row.rating\"\r\n            disabled\r\n            show-score\r\n            text-color=\"#ff9900\"\r\n          />\r\n        </template>\r\n      </el-table-column>\r\n      \r\n      <el-table-column prop=\"comment\" label=\"评价内容\" />\r\n      \r\n      <el-table-column prop=\"date\" label=\"评价时间\" width=\"180\" />\r\n      \r\n      <el-table-column label=\"操作\" width=\"150\">\r\n        <template #default=\"{ row }\">\r\n          <el-button type=\"danger\" size=\"small\" @click=\"deleteReview(row)\">删除</el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <el-empty \r\n      v-if=\"reviews.length === 0\" \r\n      description=\"暂无评价记录\"\r\n      class=\"empty-tip\"\r\n    />\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport { ref, onMounted, computed } from 'vue'\r\nimport { ElMessage, ElMessageBox } from 'element-plus'\r\nimport axios from 'axios'\r\n\r\nconst reviews = ref([])\r\n\r\n// JWT 解析函数\r\nconst parseJwt = (token) => {\r\n  try {\r\n    const base64Url = token.split('.')[1]\r\n    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/')\r\n    const jsonPayload = decodeURIComponent(\r\n      atob(base64)\r\n        .split('')\r\n        .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\r\n        .join('')\r\n    )\r\n    return JSON.parse(jsonPayload)\r\n  } catch (e) {\r\n    console.error('Token解析失败:', e)\r\n    return null\r\n  }\r\n}\r\n\r\n// 从token获取用户名\r\nconst token = localStorage.getItem('token')\r\nconst username = computed(() => {\r\n  if (token) {\r\n    const payload = parseJwt(token)\r\n    return payload.sub || 'guest'\r\n  }\r\n  return 'guest'\r\n})\r\n\r\n// 从Token获取用户ID\r\nconst getCustomerIdFromToken = () => {\r\n  const token = localStorage.getItem('token')\r\n  if (!token) {\r\n    ElMessage.error('用户未登录，请先登录')\r\n    return null\r\n  }\r\n  try {\r\n    const decoded = parseJwt(token)\r\n    return decoded.customerId || null\r\n  } catch (error) {\r\n    console.error('Token解析失败:', error)\r\n    ElMessage.error('用户信息解析失败')\r\n    return null\r\n  }\r\n}\r\n\r\n// 加载评价数据\r\nconst loadReviews = async () => {\r\n  try {\r\n    const customerId = getCustomerIdFromToken()\r\n    if (!customerId) {\r\n      ElMessage.error('无法获取用户信息')\r\n      return\r\n    }\r\n    \r\n    // 从后端获取评价列表\r\n    const response = await axios.get(\r\n      `http://algorineko.top:8080/api/customer/review/customer/${customerId}`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        }\r\n      }\r\n    )\r\n    \r\n    // 获取本地存储的商品快照\r\n    const savedReviews = JSON.parse(localStorage.getItem('productReviews') || '[]')\r\n    \r\n    // 合并数据：后端返回的评价数据 + 本地存储的商品快照\r\n    reviews.value = response.data.map(apiReview => {\r\n      // 查找本地存储中对应的评价（如果有）\r\n      const localReview = savedReviews.find(r => \r\n        r.orderItemId === apiReview.orderItemId\r\n      )\r\n      \r\n      // 使用本地存储的商品快照（如果存在）\r\n      const itemSnapshot = localReview?.itemSnapshot || {}\r\n      \r\n      return {\r\n        ...apiReview,\r\n        content: apiReview.comment, // 为了兼容原有模板\r\n        date: localReview?.date || new Date().toLocaleString(), // 保留原有日期\r\n        item: {\r\n          id: itemSnapshot.id || 0,\r\n          name: itemSnapshot.name || '商品信息缺失',\r\n          price: itemSnapshot.price || 0,\r\n          quantity: itemSnapshot.quantity || 1,\r\n          image: itemSnapshot.image || '/placeholder-product.jpg'\r\n        }\r\n      }\r\n    })\r\n    \r\n  } catch (error) {\r\n    console.error('加载评价失败:', error)\r\n    ElMessage.error('加载评价失败')\r\n    reviews.value = []\r\n  }\r\n}\r\n\r\nconst deleteReview = async (review) => {\r\n  try {\r\n    await ElMessageBox.confirm(\r\n      '确定要删除这个评价吗？删除后无法恢复',\r\n      '警告',\r\n      {\r\n        confirmButtonText: '确定删除',\r\n        cancelButtonText: '取消',\r\n        type: 'warning'\r\n      }\r\n    )\r\n    \r\n    // 调用后端API删除评价 - 使用正确的URL格式\r\n    await axios.delete(\r\n      `http://algorineko.top:8080/api/customer/review/${review.reviewId}`,\r\n      {\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\r\n        }\r\n      }\r\n    )\r\n    \r\n    // 从本地存储中移除商品快照\r\n    const savedReviews = JSON.parse(localStorage.getItem('productReviews') || '[]')\r\n    const newReviews = savedReviews.filter(r => \r\n      r.orderItemId !== review.orderItemId\r\n    )\r\n    localStorage.setItem('productReviews', JSON.stringify(newReviews))\r\n    \r\n    // 重新加载评价\r\n    loadReviews()\r\n    ElMessage.success('删除成功')\r\n    \r\n  } catch (error) {\r\n    if (error !== 'cancel') {\r\n      console.error('删除评价失败:', error)\r\n      ElMessage.error('删除评价失败')\r\n    }\r\n  }\r\n}\r\n\r\nonMounted(loadReviews)\r\n</script>\r\n\r\n<style scoped>\r\n.user-reviews {\r\n  padding: 20px;\r\n  background: #fff;\r\n}\r\n\r\n.empty-tip {\r\n  margin-top: 50px;\r\n}\r\n\r\n.product-list {\r\n  padding: 10px 0;\r\n}\r\n\r\n.product-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10px;\r\n  padding: 10px 0;\r\n}\r\n\r\n.product-details {\r\n  flex: 1;\r\n}\r\n\r\n.product-name {\r\n  font-weight: 500;\r\n  margin-bottom: 5px;\r\n  color: #606266;\r\n  text-decoration: none;\r\n  display: block;\r\n  cursor: pointer;\r\n  transition: color 0.3s;\r\n}\r\n\r\n.product-name:hover {\r\n  color: #409eff;\r\n  text-decoration: underline;\r\n}\r\n\r\n.product-price {\r\n  color: #f56c6c;\r\n  font-size: 14px;\r\n}\r\n\r\n/* 图片链接样式 */\r\na {\r\n  text-decoration: none;\r\n  color: inherit;\r\n}\r\n\r\n/* 图片悬停效果 */\r\n.el-image {\r\n  transition: transform 0.3s;\r\n}\r\n\r\n.el-image:hover {\r\n  transform: scale(1.05);\r\n}\r\n</style>","import script from \"./UserReviews.vue?vue&type=script&setup=true&lang=js\"\nexport * from \"./UserReviews.vue?vue&type=script&setup=true&lang=js\"\n\nimport \"./UserReviews.vue?vue&type=style&index=0&id=8a25580a&scoped=true&lang=css\"\n\nimport exportComponent from \"../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['__scopeId',\"data-v-8a25580a\"]])\n\nexport default __exports__"],"names":["reviews","ref","parseJwt","token","base64Url","split","base64","replace","jsonPayload","decodeURIComponent","atob","map","c","charCodeAt","toString","slice","join","JSON","parse","e","console","error","localStorage","getItem","username","computed","payload","sub","getCustomerIdFromToken","ElMessage","decoded","customerId","loadReviews","async","response","axios","get","headers","savedReviews","value","data","apiReview","localReview","find","r","orderItemId","itemSnapshot","content","comment","date","Date","toLocaleString","item","id","name","price","quantity","image","deleteReview","ElMessageBox","confirm","confirmButtonText","cancelButtonText","type","delete","review","reviewId","newReviews","filter","setItem","stringify","success","onMounted","__exports__"],"sourceRoot":""}