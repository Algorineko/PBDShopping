"use strict";(self["webpackChunkproject"]=self["webpackChunkproject"]||[]).push([[906],{3906:function(e,t,a){a.r(t),a.d(t,{default:function(){return _}});a(8111),a(1701),a(7642),a(8004),a(3853),a(5876),a(2475),a(5024),a(1698),a(4979);var r=a(6768),o=a(4232),l=a(144),n=a(1219),s=a(5934),c=a(2261),i=a(1147);const u={class:"shopping-cart"},d={key:0,class:"loading-overlay"},m={key:1,class:"error-message"},p={key:0,class:"cart-actions"},g={key:0,class:"product-info"},h={key:3,class:"checkout"},v={class:"selected-info"},y={class:"highlight"},I={class:"total"},k={class:"highlight"};var w={__name:"ShoppingCart",setup(e){const t=(0,s.x)(),{items:a,selectedItems:w,selectedTotalPrice:b,selectedItemsList:f,loading:_,error:E}=(0,c.bP)(t),C=(0,l.KR)(!1),R=localStorage.getItem("token"),F=(0,r.EW)((()=>{if(R){const e=x(R);return e.sub||"guest"}return"guest"})),N=(0,r.EW)((()=>w.value.size===a.value.length&&a.value.length>0));(0,r.sV)((async()=>{a.value.length||await t.fetchCart()}));const W=async()=>{await t.fetchCart()},$=()=>{t.toggleSelectAll()},q=e=>{t.toggleSelection(e)},A=async e=>{if(e?.cartItemId)try{await t.updateQuantity(e.cartItemId,e.quantity),n.nk.success("数量更新成功")}catch(a){n.nk.error(`数量更新失败: ${a.message||"未知错误"}`)}else n.nk.error("无效的商品数据")},S=async e=>{if(e?.cartItemId)try{await t.removeItem(e.cartItemId),n.nk.success("已移除商品")}catch(a){n.nk.error(`移除商品失败: ${a.message||"未知错误"}`)}else n.nk.error("无效操作")},z=async()=>{if(0===w.value.size)return;const e=[...w.value];try{await t.removeItems(e),n.nk.success(`已删除 ${e.length} 件商品`)}catch(a){n.nk.error(`删除商品失败: ${a.message||"未知错误"}`)}},j=async e=>{try{const t=await i.A.get(`http://algorineko.top:8080/api/merchant/product/detail/${e}`);if(t.data&&t.data.merchantId)return t.data.merchantId;throw new Error("未获取到商家信息")}catch(E){throw console.error(`获取商品 ${e} 的商家信息失败:`,E),new Error(`获取商品商家信息失败: ${E.message||"未知错误"}`)}},x=e=>{try{const t=e.split(".")[1],a=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(a).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""));return JSON.parse(r)}catch(t){return console.error("Token解析失败:",t),null}},X=async()=>{if(0!==w.value.size){C.value=!0;try{const e=f.value.map((e=>j(e.id))),a=await Promise.all(e),r=[...new Set(a)];if(0===r.length)throw new Error("无法确定商家信息");if(r.length>1)throw new Error("您选择的商品来自不同商家，请分开结算");const o=r[0],l=localStorage.getItem("token");if(!l)throw new Error("请先登录后再结算");const s=x(l);if(!s||!s.customerId)throw new Error("用户信息不完整，请重新登录");console.log("payload",s);const c=f.value.map((e=>({productId:e.id,quantity:e.quantity}))),u={customerId:Number(s.customerId),merchantId:o,items:c};console.log("requestData",u);const d=await i.A.post("http://algorineko.top:8080/api/order/create",u,{headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}});if(!d.data)throw new Error("订单创建失败");const m=[...w.value];await t.removeItems(m),n.nk.success("订单创建成功！")}catch(E){let t="订单创建失败";t=E.message.includes("不同商家")||E.message.includes("商家信息")?E.message:E.response?400===E.response.status?E.response.data?.message||"请求参数错误":401===E.response.status?"身份验证失败，请重新登录":500===E.response.status?E.response.data?.message||"服务器内部错误":E.response.data?.message||"未知错误":E.message||"网络错误，请检查连接",n.nk.error(t),console.error("结算失败:",E)}finally{C.value=!1}}else n.nk.warning("请选择要结算的商品")};return(e,n)=>{const s=(0,r.g2)("el-progress"),c=(0,r.g2)("el-alert"),i=(0,r.g2)("el-button"),f=(0,r.g2)("el-checkbox"),R=(0,r.g2)("el-table-column"),j=(0,r.g2)("el-image"),x=(0,r.g2)("router-link"),L=(0,r.g2)("el-input-number"),T=(0,r.g2)("el-table"),B=(0,r.g2)("el-empty");return(0,r.uX)(),(0,r.CE)("div",u,[(0,r.Lk)("h2",null,"购物车 ("+(0,o.v_)((0,l.R1)(a)?.length||0)+")",1),(0,l.R1)(_)?((0,r.uX)(),(0,r.CE)("div",d,[(0,r.bF)(s,{percentage:50,indeterminate:!0}),n[0]||(n[0]=(0,r.Lk)("p",null,"加载购物车中...",-1))])):(0,r.Q3)("",!0),(0,l.R1)(E)?((0,r.uX)(),(0,r.CE)("div",m,[(0,r.bF)(c,{title:(0,l.R1)(E),type:"error","show-icon":""},null,8,["title"]),(0,r.bF)(i,{type:"primary",onClick:W},{default:(0,r.k6)((()=>n[1]||(n[1]=[(0,r.eW)("重试")]))),_:1,__:[1]})])):((0,r.uX)(),(0,r.CE)(r.FK,{key:2},[(0,l.R1)(a)?.length>0?((0,r.uX)(),(0,r.CE)("div",p,[(0,r.bF)(f,{"model-value":N.value,onChange:$},{default:(0,r.k6)((()=>n[2]||(n[2]=[(0,r.eW)(" 全选 ")]))),_:1,__:[2]},8,["model-value"]),(0,r.bF)(i,{type:"danger",size:"small",disabled:0===(0,l.R1)(w).size||(0,l.R1)(t).loading,loading:(0,l.R1)(t).loading,onClick:z},{default:(0,r.k6)((()=>n[3]||(n[3]=[(0,r.eW)(" 删除选中 ")]))),_:1,__:[3]},8,["disabled","loading"])])):(0,r.Q3)("",!0),(0,l.R1)(a)?.length>0?((0,r.uX)(),(0,r.Wv)(T,{key:1,data:(0,l.R1)(a),border:"",style:{width:"100%"}},{default:(0,r.k6)((()=>[(0,r.bF)(R,{width:"50",align:"center"},{header:(0,r.k6)((()=>[(0,r.bF)(f,{"model-value":N.value,onChange:$},null,8,["model-value"])])),default:(0,r.k6)((({row:e})=>[(0,r.bF)(f,{"model-value":(0,l.R1)(w).has(e.cartItemId),onChange:t=>q(e.cartItemId)},null,8,["model-value","onChange"])])),_:1}),(0,r.bF)(R,{label:"商品",width:"300"},{default:(0,r.k6)((({row:e})=>[e?((0,r.uX)(),(0,r.CE)("div",g,[(0,r.bF)(x,{to:`/buyer/${F.value}/product/${e.id}`},{default:(0,r.k6)((()=>[(0,r.bF)(j,{src:e.image||"/placeholder-product.jpg",width:"80",style:{cursor:"pointer"}},null,8,["src"])])),_:2},1032,["to"]),(0,r.bF)(x,{to:`/buyer/${F.value}/product/${e.id}`,class:"product-link"},{default:(0,r.k6)((()=>[(0,r.eW)((0,o.v_)(e.name||"未知商品"),1)])),_:2},1032,["to"])])):(0,r.Q3)("",!0)])),_:1}),(0,r.bF)(R,{label:"单价",width:"120"},{default:(0,r.k6)((({row:e})=>[(0,r.eW)(" ¥"+(0,o.v_)((e.price||0).toFixed(2)),1)])),_:1}),(0,r.bF)(R,{label:"数量",width:"150"},{default:(0,r.k6)((({row:e})=>[(0,r.bF)(L,{modelValue:e.quantity,"onUpdate:modelValue":t=>e.quantity=t,min:1,max:99,disabled:(0,l.R1)(t).loading,onChange:t=>A(e)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"])])),_:1}),(0,r.bF)(R,{label:"小计",width:"120"},{default:(0,r.k6)((({row:e})=>[(0,r.eW)(" ¥"+(0,o.v_)(((e.price||0)*(e.quantity||1)).toFixed(2)),1)])),_:1}),(0,r.bF)(R,{label:"操作",width:"120"},{default:(0,r.k6)((({row:e})=>[(0,r.bF)(i,{type:"danger",disabled:(0,l.R1)(t).loading,loading:(0,l.R1)(t).loading,onClick:t=>S(e)},{default:(0,r.k6)((()=>n[4]||(n[4]=[(0,r.eW)(" 删除 ")]))),_:2,__:[4]},1032,["disabled","loading","onClick"])])),_:1})])),_:1},8,["data"])):((0,r.uX)(),(0,r.Wv)(B,{key:2,description:"您的购物车还是空的，快去选购商品吧！",class:"empty-tip"})),(0,l.R1)(a)?.length>0?((0,r.uX)(),(0,r.CE)("div",h,[(0,r.Lk)("div",v,[n[5]||(n[5]=(0,r.eW)(" 已选 ")),(0,r.Lk)("span",y,(0,o.v_)((0,l.R1)(w).size),1),n[6]||(n[6]=(0,r.eW)(" 件商品 "))]),(0,r.Lk)("div",I,[n[7]||(n[7]=(0,r.eW)(" 合计：")),(0,r.Lk)("span",k,"¥"+(0,o.v_)(((0,l.R1)(b)||0).toFixed(2)),1)]),(0,r.bF)(i,{type:"primary",size:"large",disabled:0===(0,l.R1)(w).size||(0,l.R1)(t).loading||C.value,loading:C.value,onClick:X},{default:(0,r.k6)((()=>n[8]||(n[8]=[(0,r.eW)(" 去结算 ")]))),_:1,__:[8]},8,["disabled","loading"])])):(0,r.Q3)("",!0)],64))])}}},b=a(1241);const f=(0,b.A)(w,[["__scopeId","data-v-a9ef86cc"]]);var _=f},5934:function(e,t,a){a.d(t,{x:function(){return c}});a(4114),a(8111),a(2489),a(116),a(7588),a(1701),a(8237),a(7642),a(8004),a(3853),a(5876),a(2475),a(5024),a(1698),a(4979);var r=a(2261),o=a(144),l=a(6768),n=a(1147);const s=e=>{try{const t=e.split(".")[1],a=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(a).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""));return JSON.parse(r)}catch(t){return console.error("Token解析失败:",t),null}},c=(0,r.nY)("cart",(()=>{const e=(0,o.KR)([]),t=(0,o.KR)(new Set),a=(0,o.KR)(!1),r=(0,o.KR)(null),c=async e=>{try{const t=await n.A.get(`http://algorineko.top:8080/api/merchant/product/detail/${e}`);return t.data}catch(t){return console.error(`获取商品详情失败 (ID: ${e}):`,t),null}},i=t=>{const a=e.value.find((e=>e.id===t.id));a?a.quantity+=Number(t.quantity)||1:e.value.push({id:t.id,name:t.name||"未知商品",price:Number(t.price)||0,quantity:Math.max(1,Number(t.quantity)||1),image:t.image||"/placeholder-product.jpg",cartItemId:t.cartItemId})},u=async e=>{const t=localStorage.getItem("token");if(!t)throw new Error("请先登录后再添加商品到购物车");const a=s(t);if(!a||!a.customerId)throw new Error("用户信息不完整，请重新登录");const o={customerId:Number(a.customerId),productId:Number(e.id),quantity:Number(e.quantity),selectedOptions:""};try{const a=await n.A.post("http://algorineko.top:8080/api/customer/cart/add",o,{headers:{Authorization:`Bearer ${t}`}});return i({id:e.id,name:e.name,price:e.price,quantity:e.quantity,image:e.image}),a.data}catch(r){let t="加入购物车失败";throw t=r.response?400===r.response.status?r.response.data?.message||"请求参数错误":401===r.response.status?"身份验证失败，请重新登录":500===r.response.status?r.response.data?.message||"服务器内部错误":r.response.data?.message||"未知错误":r.message||"网络错误，请检查连接",new Error(t)}},d=async()=>{a.value=!0,r.value=null;try{const t=localStorage.getItem("token");if(!t)throw new Error("用户未登录");const a=await n.A.get("http://algorineko.top:8080/api/customer/cart/get",{headers:{Authorization:`Bearer ${t}`}}),r=[];for(const e of a.data){const t=await c(e.productId);r.push({id:e.productId,cartItemId:e.cartItemId,name:t?.productName||e.productName||"未知商品",price:Number(t?.price)||Number(e.price)||0,quantity:Math.max(1,Number(e.quantity)||1),image:e.image||"/placeholder-product.jpg"})}e.value=r}catch(t){r.value=t.response?.data?.message||t.message,console.error("获取购物车失败:",t),e.value.length||(e.value=[])}finally{a.value=!1}},m=async(t,o)=>{a.value=!0;try{const a=localStorage.getItem("token");if(!a)throw new Error("用户未登录");const r=s(a);if(!r||!r.customerId)throw new Error("用户信息不完整，请重新登录");const l=e.value.find((e=>e.cartItemId===t));if(!l)throw new Error("购物车项不存在");const c={cartItemId:Number(t),customerId:Number(r.customerId),productId:Number(l.id),quantity:Number(o),selectedOptions:""};await n.A.put(`http://algorineko.top:8080/api/customer/cart/${t}`,c,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"}}),l&&(l.quantity=o)}catch(l){r.value=l.response?.data?.message||l.message,console.error("更新购物车项失败:",l),await d()}finally{a.value=!1}},p=async o=>{a.value=!0;try{const a=localStorage.getItem("token");if(!a)throw new Error("用户未登录");await n.A.delete(`http://algorineko.top:8080/api/customer/cart/${o}`,{headers:{Authorization:`Bearer ${a}`}}),e.value=e.value.filter((e=>e.cartItemId!==o)),t.value.delete(o)}catch(l){r.value=l.response?.data?.message||l.message,console.error("删除购物车项失败:",l)}finally{a.value=!1}},g=async o=>{a.value=!0;try{const a=localStorage.getItem("token");if(!a)throw new Error("用户未登录");await Promise.all(o.map((e=>n.A.delete(`http://algorineko.top:8080/api/customer/cart/${e}`,{headers:{Authorization:`Bearer ${a}`}})))),e.value=e.value.filter((e=>!o.includes(e.cartItemId))),o.forEach((e=>t.value.delete(e)))}catch(l){r.value=l.response?.data?.message||l.message,console.error("批量删除购物车项失败:",l)}finally{a.value=!1}},h=(0,l.EW)((()=>e.value.reduce(((e,t)=>{const a=Number(t.price)||0,r=Number(t.quantity)||1;return e+a*r}),0))),v=(0,l.EW)((()=>e.value.reduce(((e,a)=>{if(t.value.has(a.cartItemId)){const t=Number(a.price)||0,r=Number(a.quantity)||1;return e+t*r}return e}),0))),y=(0,l.EW)((()=>e.value.filter((e=>t.value.has(e.cartItemId))))),I=e=>{t.value.has(e)?t.value.delete(e):t.value.add(e)},k=()=>{t.value.size===e.value.length?t.value.clear():e.value.forEach((e=>t.value.add(e.cartItemId)))},w=()=>t.value.clear();return{items:(0,l.EW)((()=>e.value)),totalPrice:h,selectedTotalPrice:v,selectedItems:(0,l.EW)((()=>t.value)),selectedItemsList:y,loading:(0,l.EW)((()=>a.value)),error:(0,l.EW)((()=>r.value)),fetchCart:d,updateQuantity:m,addItemToCart:u,removeItem:p,removeItems:g,toggleSelection:I,toggleSelectAll:k,clearSelected:w}}))}}]);
//# sourceMappingURL=906.836c60c6.js.map