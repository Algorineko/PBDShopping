"use strict";(self["webpackChunkproject"]=self["webpackChunkproject"]||[]).push([[675],{6675:function(e,a,t){t.r(a),t.d(a,{default:function(){return A}});var s=t(6768),o=t(4232);const r={class:"user-profile"},l={class:"info-card"},i={class:"info-item"},d={class:"info-content"},n={class:"info-item"},c={class:"info-content"},u={class:"info-item"},m={class:"info-content"},p={class:"info-item"},h={class:"avatar-preview"},g={class:"username-display"},f={class:"info-content"},k={class:"avatar-upload"},v={class:"avatar-actions"},F={class:"dialog-footer"};function w(e,a,t,w,b,_){const L=(0,s.g2)("el-avatar"),y=(0,s.g2)("el-button"),D=(0,s.g2)("el-input"),V=(0,s.g2)("el-form-item"),A=(0,s.g2)("el-upload"),P=(0,s.g2)("el-form"),C=(0,s.g2)("el-dialog");return(0,s.uX)(),(0,s.CE)("div",r,[a[21]||(a[21]=(0,s.Lk)("h2",null,"我的信息",-1)),(0,s.Lk)("div",l,[(0,s.Lk)("div",i,[a[7]||(a[7]=(0,s.Lk)("label",null,"用户名：",-1)),(0,s.Lk)("span",d,(0,o.v_)(b.userData.username||"未设置"),1)]),(0,s.Lk)("div",n,[a[8]||(a[8]=(0,s.Lk)("label",null,"收货地址：",-1)),(0,s.Lk)("span",c,(0,o.v_)(b.userData.address||"暂无收货地址"),1)]),(0,s.Lk)("div",u,[a[9]||(a[9]=(0,s.Lk)("label",null,"手机号码：",-1)),(0,s.Lk)("span",m,(0,o.v_)(b.userData.contact||"暂无手机号码"),1)]),(0,s.Lk)("div",p,[a[11]||(a[11]=(0,s.Lk)("label",null,"用户头像：",-1)),(0,s.Lk)("div",h,[(0,s.bF)(L,{size:80,src:b.userData.avatar||b.defaultAvatar},null,8,["src"]),a[10]||(a[10]=(0,s.Lk)("div",{class:"avatar-tip"},"头像仅本地保存",-1))])]),(0,s.bF)(y,{type:"primary",onClick:_.handleEditClick,class:"edit-button"},{default:(0,s.k6)((()=>a[12]||(a[12]=[(0,s.eW)(" 编辑信息 ")]))),_:1,__:[12]},8,["onClick"])]),(0,s.bF)(C,{modelValue:b.showDialog,"onUpdate:modelValue":a[6]||(a[6]=e=>b.showDialog=e),title:"修改个人信息",width:"500px",onOpen:_.handleDialogOpen},{footer:(0,s.k6)((()=>[(0,s.Lk)("div",F,[(0,s.bF)(y,{onClick:a[5]||(a[5]=e=>b.showDialog=!1)},{default:(0,s.k6)((()=>a[19]||(a[19]=[(0,s.eW)("取消")]))),_:1,__:[19]}),(0,s.bF)(y,{type:"primary",onClick:_.submitForm,loading:b.loading},{default:(0,s.k6)((()=>a[20]||(a[20]=[(0,s.eW)(" 确认修改 ")]))),_:1,__:[20]},8,["onClick","loading"])])])),default:(0,s.k6)((()=>[(0,s.bF)(P,{ref:"formRef",model:b.editForm,rules:b.formRules,"label-width":"100px"},{default:(0,s.k6)((()=>[(0,s.Lk)("div",g,[a[13]||(a[13]=(0,s.Lk)("label",null,"用户名：",-1)),(0,s.Lk)("span",f,(0,o.v_)(b.userData.username||"未设置"),1),a[14]||(a[14]=(0,s.Lk)("div",{class:"info-tip"},"用户名不可修改",-1))]),(0,s.bF)(V,{label:"旧密码"},{default:(0,s.k6)((()=>[(0,s.bF)(D,{modelValue:b.editForm.oldPassword,"onUpdate:modelValue":a[0]||(a[0]=e=>b.editForm.oldPassword=e),type:"password","show-password":"",placeholder:"请输入当前密码"},null,8,["modelValue"])])),_:1}),(0,s.bF)(V,{label:"新密码"},{default:(0,s.k6)((()=>[(0,s.bF)(D,{modelValue:b.editForm.password,"onUpdate:modelValue":a[1]||(a[1]=e=>b.editForm.password=e),type:"password","show-password":"",placeholder:"请输入新密码"},null,8,["modelValue"]),a[15]||(a[15]=(0,s.Lk)("div",{class:"info-tip"},"留空则不修改密码",-1))])),_:1,__:[15]}),(0,s.bF)(V,{label:"收货地址",prop:"address"},{default:(0,s.k6)((()=>[(0,s.bF)(D,{modelValue:b.editForm.address,"onUpdate:modelValue":a[2]||(a[2]=e=>b.editForm.address=e),type:"textarea",rows:3,placeholder:"请输入详细收货地址",maxlength:"100","show-word-limit":""},null,8,["modelValue"])])),_:1}),(0,s.bF)(V,{label:"手机号码",prop:"contact"},{default:(0,s.k6)((()=>[(0,s.bF)(D,{modelValue:b.editForm.contact,"onUpdate:modelValue":a[3]||(a[3]=e=>b.editForm.contact=e),placeholder:"请输入手机号码"},null,8,["modelValue"])])),_:1}),(0,s.bF)(V,{label:"用户头像"},{default:(0,s.k6)((()=>[(0,s.Lk)("div",k,[(0,s.bF)(L,{size:120,src:b.editForm.avatar||b.defaultAvatar,class:"avatar-preview"},null,8,["src"]),(0,s.Lk)("div",v,[(0,s.bF)(A,{action:"#","show-file-list":!1,"auto-upload":!1,"on-change":_.handleAvatarChange,accept:"image/*"},{default:(0,s.k6)((()=>[(0,s.bF)(y,{type:"primary",icon:"el-icon-upload",size:"small"},{default:(0,s.k6)((()=>a[16]||(a[16]=[(0,s.eW)("上传头像")]))),_:1,__:[16]})])),_:1},8,["on-change"]),b.editForm.avatar?((0,s.uX)(),(0,s.Wv)(y,{key:0,type:"danger",icon:"el-icon-delete",size:"small",onClick:a[4]||(a[4]=e=>b.editForm.avatar="")},{default:(0,s.k6)((()=>a[17]||(a[17]=[(0,s.eW)(" 移除 ")]))),_:1,__:[17]})):(0,s.Q3)("",!0)])]),a[18]||(a[18]=(0,s.Lk)("div",{class:"info-tip"},"头像仅本地保存，更换设备将丢失",-1))])),_:1,__:[18]})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","onOpen"])])}var b=t(1219),_=t(1147);const L="https://cube.elemecdn.com/3/7c/3ea6beec64369c2642b92c6726f1epng.png";var y={data(){const e=(e,a,t)=>{a&&!/^1[3-9]\d{9}$/.test(a)?t(new Error("请输入正确的手机号码")):t()};return{defaultAvatar:L,userData:{username:"",address:"",contact:"",avatar:""},showDialog:!1,loading:!1,editForm:{oldPassword:"",password:"",address:"",contact:"",avatar:""},formRules:{address:[{required:!0,message:"收货地址不能为空",trigger:"blur"},{max:100,message:"最多可输入100个字符",trigger:"blur"}],contact:[{validator:e,trigger:"blur"}]}}},mounted(){this.fetchUserProfile()},methods:{checkTokenValidity(){const e=localStorage.getItem("token");return!!e||(b.nk.error("用户未登录，请重新登录"),this.redirectToLogin(),!1)},redirectToLogin(){localStorage.removeItem("token"),setTimeout((()=>{window.location.href="/login"}),1500)},async fetchUserProfile(){if(this.checkTokenValidity())try{const e=localStorage.getItem("token"),a=await _.A.get("http://algorineko.top:8080/api/customer/profile",{headers:{Authorization:`Bearer ${e}`},timeout:1e4});console.log("用户信息响应数据:",a.data);const t=a.data||{};this.userData={username:t.customerName||"",address:t.address||"",contact:t.phoneNumber||"",avatar:this.getAvatarFromStorage()},localStorage.setItem("userName",this.userData.username),t.customerId&&localStorage.setItem("userId",t.customerId.toString())}catch(e){console.error("获取用户信息失败:",e);let a="获取用户信息失败";e.response&&(401===e.response.status?(a="身份验证失败，请重新登录",this.redirectToLogin()):e.response.data?.message&&(a=e.response.data.message)),b.nk.error(a)}},getAvatarFromStorage(){const e=JSON.parse(localStorage.getItem("userProfile")||"{}");return e.avatar||""},handleEditClick(){this.showDialog=!0,this.editForm={address:this.userData.address,contact:this.userData.contact,avatar:this.userData.avatar,oldPassword:"",password:""}},handleDialogOpen(){this.$nextTick((()=>{this.$refs.formRef&&this.$refs.formRef.clearValidate()}))},handleAvatarChange(e){if(!e)return;const a=["image/jpeg","image/png","image/gif"],t=e.size/1024/1024<2;if(!a.includes(e.raw.type))return void b.nk.error("只支持 JPG/PNG/GIF 格式!");if(!t)return void b.nk.error("头像大小不能超过 2MB!");const s=new FileReader;s.onload=e=>{this.editForm.avatar=e.target.result},s.readAsDataURL(e.raw)},async submitForm(){this.$refs.formRef.validate((async e=>{if(e)try{this.loading=!0;const e=localStorage.getItem("token");if(!e)return void b.nk.error("用户未登录");if(await _.A.put("http://algorineko.top:8080/api/customer/putProfile",{address:this.editForm.address,phoneNumber:this.editForm.contact},{headers:{Authorization:`Bearer ${e}`},timeout:1e4}),this.editForm.password){if(!this.editForm.oldPassword)return b.nk.warning("修改密码需要提供旧密码"),void(this.loading=!1);await _.A.put("http://algorineko.top:8080/api/customer/change-password",{oldPassword:this.editForm.oldPassword,newPassword:this.editForm.password},{headers:{Authorization:`Bearer ${e}`},timeout:1e4})}this.userData={...this.userData,address:this.editForm.address,contact:this.editForm.contact,avatar:this.editForm.avatar},localStorage.setItem("userProfile",JSON.stringify({address:this.editForm.address,contact:this.editForm.contact,avatar:this.editForm.avatar})),b.nk.success("修改成功"),this.showDialog=!1}catch(a){console.error("保存失败:",a);let e="保存失败，请重试";a.response&&(401===a.response.status?(e="身份验证失败，请重新登录",this.redirectToLogin()):400===a.response.status?e=a.response.data.message||"请求参数错误":403===a.response.status?e="旧密码不正确":a.response.data&&a.response.data.message&&(e=a.response.data.message)),b.nk.error(e)}finally{this.loading=!1}else b.nk.warning("请正确填写表单")}))}}},D=t(1241);const V=(0,D.A)(y,[["render",w],["__scopeId","data-v-2c974b46"]]);var A=V}}]);
//# sourceMappingURL=675.c137690a.js.map