"use strict";(self["webpackChunkproject"]=self["webpackChunkproject"]||[]).push([[54],{5054:function(e,t,a){a.r(t),a.d(t,{default:function(){return f}});a(4114),a(8111),a(2489),a(531),a(7588),a(1701),a(3579),a(7642),a(8004),a(3853),a(5876),a(2475),a(5024),a(1698),a(4979);var r=a(6768),l=a(4232),o=a(144),s=a(1219),n=a(1147);const i={class:"user-orders"},u={class:"filter-section"},d={class:"product-list"},c={class:"product-item"},p={class:"product-details"},m={class:"product-price"},g={key:0},v={key:2,class:"pagination"};var k={__name:"UserOrders",setup(e){const t={PENDING:"待付款",PAID:"待发货",SHIPPED:"已发货",COMPLETED:"已完成",CANCELED:"已取消",pending:"待付款",paid:"待发货",shipped:"已发货",completed:"已完成",canceled:"已取消"},a={PENDING:"warning",PAID:"primary",SHIPPED:"primary",COMPLETED:"success",CANCELED:"info",pending:"warning",paid:"primary",shipped:"primary",completed:"success",canceled:"info"},k=e=>{try{const t=e.split(".")[1],a=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(a).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""));return JSON.parse(r)}catch(t){return console.error("Token解析失败:",t),null}},I=localStorage.getItem("token"),h=(0,r.EW)((()=>{if(I){const e=k(I);return e.sub||"guest"}return"guest"})),f=(0,o.KR)([{value:"all",label:"全部状态"},{value:"PENDING",label:"待付款"},{value:"PAID",label:"待发货"},{value:"SHIPPED",label:"已发货"},{value:"COMPLETED",label:"已完成"}]),w=(0,o.KR)([]),y=(0,o.KR)("all"),b=(0,o.KR)([]),_=(0,o.KR)(0),E=(0,o.KR)(10),C=(0,o.KR)(1),P=(0,o.KR)(!1),S=(0,o.KR)({orderItemId:"",customerId:"",rating:5,content:""}),D=(0,o.KR)(null),F=(0,o.KR)(!1),N=(0,o.KR)({logisticsCompany:"",trackingNumber:""}),L=()=>{const e=localStorage.getItem("token");if(!e)return s.nk.error("用户未登录，请先登录"),null;try{const t=k(e);return t.customerId||null}catch(t){return console.error("Token解析失败:",t),s.nk.error("用户信息解析失败"),null}},A=async(e,t)=>{try{const a=await n.A.put(`http://algorineko.top:8080/api/order/updateStatus?orderId=${e}&status=${t}`,{},{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});return!0===a.data}catch(a){return console.error("更新订单状态失败:",a),s.nk.error("更新订单状态失败"),!1}},W=async()=>{try{const e=L();if(!e)return void s.nk.error("无法获取用户信息");const t=await n.A.get(`http://algorineko.top:8080/api/order/customer/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=t.data.map((e=>({orderId:e.orderId,merchantId:e.merchantId,totalPrice:e.totalPrice,status:e.status,createTime:(new Date).toLocaleString(),items:e.items.map((e=>({id:e.productId,name:`商品 ${e.productId}`,price:e.price,quantity:e.quantity,image:"https://via.placeholder.com/60",orderItemId:e.orderItemId})))}))),r=[...new Set(a.flatMap((e=>e.items.map((e=>e.id)))))],l=r.map((e=>n.A.get(`http://algorineko.top:8080/api/merchant/product/detail/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}).catch((t=>(console.error(`获取商品${e}详情失败:`,t),null))))),o=await Promise.all(l),i={};o.forEach(((e,t)=>{if(e&&e.data){const a=e.data;i[r[t]]={name:a.productName,image:a.images&&a.images.length>0?a.images[0]:"https://via.placeholder.com/60"}}})),a.forEach((e=>{e.items.forEach((e=>{const t=i[e.id];t&&(e.name=t.name,e.image=t.image)}))}));const u=JSON.parse(localStorage.getItem("productReviews")||"[]");a.forEach((e=>{e.isPaid=["PAID","SHIPPED","COMPLETED"].includes(e.status),e.items.forEach((e=>{const t=u.some((t=>t.orderItemId===e.orderItemId));e.reviewed=t}))})),localStorage.setItem("orders",JSON.stringify(a));let d=[...a];if("all"!==y.value&&(d=d.filter((e=>e.status===y.value))),b.value&&2===b.value.length){const e=new Date(b.value[0]),t=new Date(b.value[1]);t.setHours(23,59,59,999),d=d.filter((a=>{const r=new Date(a.createTime);return r>=e&&r<=t}))}const c=[];d.forEach((e=>{e.items.forEach(((t,a)=>{c.push({...e,item:t,isFirst:0===a})}))}));const p=(C.value-1)*E.value;w.value=c.slice(p,p+E.value),_.value=c.length}catch(e){console.error("订单加载失败:",e);let t="订单加载失败";e.response?401===e.response.status?t="用户未认证，请重新登录":403===e.response.status?t="没有权限访问订单数据":e.response.data&&e.response.data.message&&(t=e.response.data.message):e.request&&(t="无法连接到服务器，请检查网络连接"),s.nk.error(t),w.value=[]}},O=e=>{D.value=e;const t=L();S.value={orderItemId:e.item.orderItemId,customerId:t,rating:5,content:""},P.value=!0},V=async()=>{try{const e=localStorage.getItem("token");if(!e)return void s.nk.error("用户未登录");const t=await n.A.post("http://algorineko.top:8080/api/customer/review/add",{orderItemId:S.value.orderItemId,customerId:S.value.customerId,rating:S.value.rating,comment:S.value.content},{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if("评论提交成功"===t.data){const e=JSON.parse(localStorage.getItem("productReviews")||"[]");e.push({orderItemId:S.value.orderItemId,rating:S.value.rating,content:S.value.content,date:(new Date).toLocaleString(),itemSnapshot:{id:D.value.item.id,name:D.value.item.name,price:D.value.item.price,quantity:D.value.item.quantity,image:D.value.item.image}}),localStorage.setItem("productReviews",JSON.stringify(e)),s.nk.success("评价提交成功"),P.value=!1,W()}else s.nk.error("评价提交失败："+t.data)}catch(e){console.error("评价提交失败:",e);let t="评价提交失败";e.response&&e.response.data&&(t+=`: ${e.response.data}`),s.nk.error(t)}},$=async e=>{if(!e)return void s.nk.warning("无效的订单号");const t=await A(e,"PAID");if(t){const t=JSON.parse(localStorage.getItem("orders")||"[]"),a=t.map((t=>t.orderId===e?{...t,status:"PAID",isPaid:!0}:t));localStorage.setItem("orders",JSON.stringify(a)),s.nk.success(`订单 #${e} 支付成功，等待商家发货`),W()}},R=async e=>{if(!e)return void s.nk.warning("无效的订单号");const t=await A(e,"COMPLETED");if(t){const t=JSON.parse(localStorage.getItem("orders")||"[]"),a=t.map((t=>t.orderId===e?{...t,status:"COMPLETED"}:t));localStorage.setItem("orders",JSON.stringify(a)),s.nk.success(`订单 #${e} 确认收货成功`),W()}},T=e=>{C.value=e,W()},K=async e=>{try{N.value={logisticsCompany:"",trackingNumber:""};const t=await n.A.get(`http://algorineko.top:8080/api/order/tracking/${e.orderId}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),a=t.data.itemLogistics,r=e.item.orderItemId;if(a&&a[r]){const e=a[r];N.value={logisticsCompany:e.logisticsCompany||"未知",trackingNumber:e.trackingNumber||"暂无"}}else s.nk.warning("未找到该订单项的物流信息");F.value=!0}catch(t){console.error("获取物流信息失败:",t),s.nk.error("获取物流信息失败")}};return(0,r.sV)((()=>{W()})),(e,o)=>{const s=(0,r.g2)("el-option"),n=(0,r.g2)("el-select"),k=(0,r.g2)("el-date-picker"),I=(0,r.g2)("el-table-column"),C=(0,r.g2)("el-image"),D=(0,r.g2)("router-link"),L=(0,r.g2)("el-tag"),A=(0,r.g2)("el-button"),X=(0,r.g2)("el-table"),z=(0,r.g2)("el-empty"),M=(0,r.g2)("el-pagination"),J=(0,r.g2)("el-rate"),U=(0,r.g2)("el-form-item"),q=(0,r.g2)("el-input"),x=(0,r.g2)("el-form"),H=(0,r.g2)("el-dialog");return(0,r.uX)(),(0,r.CE)("div",i,[o[16]||(o[16]=(0,r.Lk)("h2",null,"我的订单",-1)),(0,r.Lk)("div",u,[(0,r.bF)(n,{modelValue:y.value,"onUpdate:modelValue":o[0]||(o[0]=e=>y.value=e),placeholder:"全部状态",onChange:W},{default:(0,r.k6)((()=>[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(f.value,(e=>((0,r.uX)(),(0,r.Wv)(s,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"]),(0,r.bF)(k,{modelValue:b.value,"onUpdate:modelValue":o[1]||(o[1]=e=>b.value=e),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",onChange:W},null,8,["modelValue"])]),w.value.length>0?((0,r.uX)(),(0,r.Wv)(X,{key:0,data:w.value,border:"",style:{width:"100%"}},{default:(0,r.k6)((()=>[(0,r.bF)(I,{prop:"orderId",label:"订单号",width:"200"}),(0,r.bF)(I,{prop:"createTime",label:"下单时间",width:"180"}),(0,r.bF)(I,{label:"商品信息"},{default:(0,r.k6)((({row:e})=>[(0,r.Lk)("div",d,[(0,r.Lk)("div",c,[(0,r.bF)(D,{to:`/buyer/${h.value}/product/${e.item.id}`},{default:(0,r.k6)((()=>[(0,r.bF)(C,{src:e.item.image,style:{width:"60px",height:"60px",cursor:"pointer"},fit:"cover"},null,8,["src"])])),_:2},1032,["to"]),(0,r.Lk)("div",p,[(0,r.bF)(D,{to:`/buyer/${h.value}/product/${e.item.id}`,class:"product-name"},{default:(0,r.k6)((()=>[(0,r.eW)((0,l.v_)(e.item.name),1)])),_:2},1032,["to"]),(0,r.Lk)("div",m," ¥"+(0,l.v_)((e.item.price||0).toFixed(2))+" × "+(0,l.v_)(e.item.quantity||1),1)])])])])),_:1}),(0,r.bF)(I,{label:"金额",width:"120",align:"right"},{default:(0,r.k6)((e=>[(0,r.eW)(" ¥"+(0,l.v_)((e.row.item.price*e.row.item.quantity).toFixed(2)),1)])),_:1}),(0,r.bF)(I,{label:"状态",width:"120"},{default:(0,r.k6)((e=>[(0,r.bF)(L,{type:a[e.row.status]||"info"},{default:(0,r.k6)((()=>[(0,r.eW)((0,l.v_)(t[e.row.status]||"未知状态"),1)])),_:2},1032,["type"])])),_:1}),(0,r.bF)(I,{label:"操作",width:"250"},{default:(0,r.k6)((e=>[e.row.isFirst?((0,r.uX)(),(0,r.CE)("div",g,["pending"===e.row.status||"PENDING"===e.row.status?((0,r.uX)(),(0,r.Wv)(A,{key:0,type:"success",size:"small",onClick:t=>$(e.row.orderId)},{default:(0,r.k6)((()=>o[8]||(o[8]=[(0,r.eW)(" 付款 ")]))),_:2,__:[8]},1032,["onClick"])):(0,r.Q3)("",!0),"shipped"===e.row.status||"SHIPPED"===e.row.status?((0,r.uX)(),(0,r.Wv)(A,{key:1,type:"warning",size:"small",onClick:t=>R(e.row.orderId)},{default:(0,r.k6)((()=>o[9]||(o[9]=[(0,r.eW)(" 确认收货 ")]))),_:2,__:[9]},1032,["onClick"])):(0,r.Q3)("",!0),"shipped"===e.row.status||"SHIPPED"===e.row.status||"completed"===e.row.status||"COMPLETED"===e.row.status?((0,r.uX)(),(0,r.Wv)(A,{key:2,type:"info",size:"small",onClick:t=>K(e.row)},{default:(0,r.k6)((()=>o[10]||(o[10]=[(0,r.eW)(" 物流详情 ")]))),_:2,__:[10]},1032,["onClick"])):(0,r.Q3)("",!0)])):(0,r.Q3)("",!0),"completed"!==e.row.status&&"COMPLETED"!==e.row.status||!e.row.isPaid||e.row.item.reviewed?(0,r.Q3)("",!0):((0,r.uX)(),(0,r.Wv)(A,{key:1,type:"warning",size:"small",onClick:t=>O(e.row)},{default:(0,r.k6)((()=>o[11]||(o[11]=[(0,r.eW)(" 评价 ")]))),_:2,__:[11]},1032,["onClick"])),("completed"===e.row.status||"COMPLETED"===e.row.status)&&e.row.isPaid&&e.row.item.reviewed?((0,r.uX)(),(0,r.Wv)(L,{key:2,type:"success"},{default:(0,r.k6)((()=>o[12]||(o[12]=[(0,r.eW)(" 已评价 ")]))),_:1,__:[12]})):(0,r.Q3)("",!0)])),_:1})])),_:1},8,["data"])):((0,r.uX)(),(0,r.Wv)(z,{key:1,description:"暂无订单数据",class:"empty-placeholder"})),w.value.length>0?((0,r.uX)(),(0,r.CE)("div",v,[(0,r.bF)(M,{background:"",layout:"prev, pager, next",total:_.value,"page-size":E.value,onCurrentChange:T},null,8,["total","page-size"])])):(0,r.Q3)("",!0),(0,r.bF)(H,{modelValue:P.value,"onUpdate:modelValue":o[5]||(o[5]=e=>P.value=e),title:"商品评价"},{footer:(0,r.k6)((()=>[(0,r.bF)(A,{onClick:o[4]||(o[4]=e=>P.value=!1)},{default:(0,r.k6)((()=>o[13]||(o[13]=[(0,r.eW)("取消")]))),_:1,__:[13]}),(0,r.bF)(A,{type:"primary",onClick:V},{default:(0,r.k6)((()=>o[14]||(o[14]=[(0,r.eW)("提交评价")]))),_:1,__:[14]})])),default:(0,r.k6)((()=>[(0,r.bF)(x,{model:S.value},{default:(0,r.k6)((()=>[(0,r.bF)(U,{label:"评分"},{default:(0,r.k6)((()=>[(0,r.bF)(J,{modelValue:S.value.rating,"onUpdate:modelValue":o[2]||(o[2]=e=>S.value.rating=e)},null,8,["modelValue"])])),_:1}),(0,r.bF)(U,{label:"评价内容"},{default:(0,r.k6)((()=>[(0,r.bF)(q,{modelValue:S.value.content,"onUpdate:modelValue":o[3]||(o[3]=e=>S.value.content=e),type:"textarea",rows:4,placeholder:"请输入您的使用体验"},null,8,["modelValue"])])),_:1})])),_:1},8,["model"])])),_:1},8,["modelValue"]),(0,r.bF)(H,{modelValue:F.value,"onUpdate:modelValue":o[7]||(o[7]=e=>F.value=e),title:"物流详情"},{footer:(0,r.k6)((()=>[(0,r.bF)(A,{type:"primary",onClick:o[6]||(o[6]=e=>F.value=!1)},{default:(0,r.k6)((()=>o[15]||(o[15]=[(0,r.eW)("关闭")]))),_:1,__:[15]})])),default:(0,r.k6)((()=>[(0,r.bF)(x,{"label-width":"100px"},{default:(0,r.k6)((()=>[(0,r.bF)(U,{label:"物流公司："},{default:(0,r.k6)((()=>[(0,r.Lk)("span",null,(0,l.v_)(N.value.logisticsCompany),1)])),_:1}),(0,r.bF)(U,{label:"物流单号："},{default:(0,r.k6)((()=>[(0,r.Lk)("span",null,(0,l.v_)(N.value.trackingNumber),1)])),_:1})])),_:1})])),_:1},8,["modelValue"])])}}},I=a(1241);const h=(0,I.A)(k,[["__scopeId","data-v-1ffe6f27"]]);var f=h}}]);
//# sourceMappingURL=54.ade7ac19.js.map